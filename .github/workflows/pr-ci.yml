name: Pull Request CI Load Test

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - '!**/README.md'
      - '**.js'
jobs:
  LoadTest:
    name: CI_Load_Test
    runs-on: default
    if: github.event.pull_request.draft == false
    outputs: 
      pipeline-status: ${{ steps.ci_pipeline_run.outputs.pipeline-status }}
    steps:
      - uses: actions/checkout@v4

      - name: CI Pipeline Run
        id: ci_pipeline_run
        run: |
          echo "####### ALL Env Variables ########"
          printenv | grep "GITHUB\|RUNNER" | sort -f
          echo "####### ALL Env Variables ########"

          echo "####### ALL CLI TOOLS in PATH ########"
          echo $PATH | tr ':' '\n' | while read -r line; do ls "$line" || true; done;:
          echo "####### ALL CLI TOOLS in PATH ########"
          
          ci_load_test.sh

          if [ $? != 0 ]; then
            echo "Load Test Failed"
            echo "pipeline-status={ \"pipelineStatus\": \"FAILED\" }" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "Load Test Succeeded"
            echo "pipeline-status={ \"pipelineStatus\": \"SUCCEEDED\" }" >> $GITHUB_OUTPUT
          fi

      - run: |
          echo "foo-load-report=$(cat ci_foo_load_test.log)" >> $GITHUB_ENV
          echo "bar-load-report=$(cat ci_bar_load_test.log)" >> $GITHUB_ENV

      - uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{env.foo_load_report}}`
            })
      - uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{env.bar_load_report}}`
            })
